name: NPSHARP Build ‚Ä¢ Validate ‚Ä¢ Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js (EXACT VERSION)
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      # -------------------------
      # VALIDAR AMBIENTE LINUX
      # -------------------------
      - name: Validate Project Structure
        run: |
          echo "üîç Checking Node..."
          node -v
          echo "üîç Checking NPM..."
          npm -v

          if [ ! -f "package.json" ]; then
            echo "‚ùå ERROR: package.json not found!"
            exit 1
          fi
          echo "‚úî package.json"

          if [ ! -f "gulpfile.js" ]; then
            echo "‚ùå ERROR: gulpfile.js not found!"
            exit 1
          fi
          echo "‚úî gulpfile.js"

      - name: Install Linux Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libnotify-bin \
            pkg-config \
            libsecret-1-dev \
            libkrb5-dev \
            libnss3-dev

      - name: Install NPM Dependencies
        run: npm install --force

      - name: Validate Gulp
        run: |
          npx gulp --version
          npx gulp --tasks

          if ! npm run | grep -q "compile"; then
            echo "‚ùå Missing compile script!"
            exit 1
          fi
          echo "‚úî Compile ok"

      # -------------------------
      # BUILD LINUX
      # -------------------------
      - name: Compile Linux
        run: npm run compile

      - name: Build Linux Portable
        run: npx gulp vscode-linux-x64

      - name: Zip Linux Build
        run: |
          cd out
          zip -r linux-build.zip vscode-linux-x64

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: out/linux-build.zip


  # ===================================
  # WINDOWS BUILD
  # ===================================
  build-windows:
    name: Build Windows
    runs-on: windows-2022

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js (EXACT VERSION)
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Validate Project Structure
        run: |
          if (!(Test-Path "./package.json")) {
            Write-Error "‚ùå package.json missing"
            exit 1
          }
          if (!(Test-Path "./gulpfile.js")) {
            Write-Error "‚ùå gulpfile.js missing"
            exit 1
          }

      - name: Install Dependencies
        run: npm install --force

      - name: Validate Gulp + Compile Script
        run: |
          npx gulp --version
          npx gulp --tasks
          npm run | findstr compile

      # -------------------------
      # BUILD WINDOWS
      # -------------------------
      - name: Compile Windows
        run: npm run compile

      - name: Build Portable
        run: npx gulp vscode-win32-x64

      - name: Zip Windows Build
        run: |
          cd out
          powershell Compress-Archive -Path vscode-win32-x64 -DestinationPath windows-build.zip

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: out/windows-build.zip


  # ===================================
  # FINAL RELEASE
  # ===================================
  release:
    name: Release All Artifacts
    runs-on: ubuntu-22.04
    needs: [build-linux, build-windows]

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "NPSharp Build ${{ github.run_number }}"
          files: |
            release/**/linux-build.zip
            release/**/windows-build.zip
